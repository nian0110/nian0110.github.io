<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NSNMPJGPLH"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1B3WJL96J4');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingOrm隨機圖片</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <link rel="icon" href="favicon/favicon.ico">
    <style>
        .sticky-top {
            text-align: center;
            background-color: white;
            padding: 10px 0px 0px 0px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .pinterest-grid {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            min-height: 800px;
        }

        .pinterest-item {
            position: absolute;
            width: calc(50% - 8px);
            border-radius: 8px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            will-change: transform;
        }

        @media (min-width: 768px) {
            .pinterest-item {
                width: calc(33.333% - 11px);
            }
        }

        @media (min-width: 1200px) {
            .pinterest-item {
                width: calc(25% - 12px);
            }
        }

        .pinterest-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .pinterest-item img {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 1.1em;
        }

        #count {
            text-align: center;
            color: #6c757d;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">LingOrm隨機圖片</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="index.html">首頁</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">關於我</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="sticky-top">
            <button id="refresh-btn" class="btn btn-primary mb-3">重新產生圖片</button>
        </div>
        <p id="count"></p>
        <div class="pinterest-grid">
            <!-- 圖片將被 JavaScript 動態插入到這裡 -->
        </div>
        <div class="loading">載入中...</div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>

    <script>
        class ImageGallery {
            constructor() {
                this.imageGrid = document.querySelector('.pinterest-grid');
                this.loadingElement = document.querySelector('.loading');
                this.refreshButton = document.querySelector('#refresh-btn');
                this.countElement = document.querySelector('#count');
                this.imageUrls = [];
                this.displayedImages = new Set();
                this.isLoading = false;
                this.batchSize = 12;
                this.hasMoreImages = true;
                this.items = [];
                this.columnCount = this.getColumnCount();
                this.gutter = 16;
    
                this.loadCSV().then(() => {
                    this.initialize();
                });
    
                // 監聽視窗大小改變
                this._resizeHandler = _.debounce(() => {
                    this.columnCount = this.getColumnCount();
                    this.layoutItems();
                }, 100);
                window.addEventListener('resize', this._resizeHandler);
            }
    
            getColumnCount() {
                const width = window.innerWidth;
                if (width >= 1200) return 4;
                if (width >= 768) return 3;
                return 2;
            }
    
            layoutItems() {
                const columnHeights = new Array(this.columnCount).fill(0);
                const containerWidth = this.imageGrid.clientWidth;
                const columnWidth = (containerWidth - (this.columnCount - 1) * this.gutter) / this.columnCount;
    
                this.items.forEach(item => {
                    // 找出最短的列
                    const minHeight = Math.min(...columnHeights);
                    const columnIndex = columnHeights.indexOf(minHeight);
    
                    // 計算位置
                    const x = columnIndex * (columnWidth + this.gutter);
                    const y = minHeight;
    
                    // 使用 transform 設置位置
                    item.style.transform = `translate(${x}px, ${y}px)`;
                    item.style.width = `${columnWidth}px`;
    
                    // 更新列高度
                    columnHeights[columnIndex] += item.offsetHeight + this.gutter;
                });
    
                // 更新容器高度
                const maxHeight = Math.max(...columnHeights);
                this.imageGrid.style.height = `${maxHeight}px`;
            }
    
            async loadCSV() {
                try {
                    const response = await fetch('images.csv');
                    const data = await response.text();
                    let lines = data.split('\n').filter(line => line.trim() !== "");
                    this.imageUrls = lines.slice(1).map(line => {
                        let columns = line.split(',');
                        return columns[1].trim();
                    });
    
                    if (this.imageUrls.length === 0) {
                        this.loadingElement.textContent = '沒有找到圖片';
                        return;
                    }
                } catch (error) {
                    console.error('載入 CSV 時發生錯誤:', error);
                    this.loadingElement.textContent = '載入圖片清單時發生錯誤';
                }
            }
    
            initialize() {
                this.setupRefreshButton();
                this.setupInfiniteScroll();
                this.loadImages();
                this.updateCount();
            }
    
            updateCount() {
                this.countElement.textContent = `已顯示 ${this.displayedImages.size} / ${this.imageUrls.length} 張圖片`;
            }
    
            getRandomImages(count) {
                const availableImages = this.imageUrls.filter(url => !this.displayedImages.has(url));
                if (availableImages.length === 0) {
                    this.hasMoreImages = false;
                    return [];
                }
                return _.sampleSize(availableImages, Math.min(count, availableImages.length));
            }
    
            createImageElement(url) {
                const item = document.createElement('div');
                item.className = 'pinterest-item';
                
                const img = document.createElement('img');
                img.src = url;
                img.alt = '隨機圖片';
                img.loading = 'lazy';
                
                // 當圖片載入完成時更新布局
                img.onload = () => {
                    this.layoutItems();
                };
                
                item.addEventListener('click', () => {
                    window.open(url, '_blank');
                });
                
                item.appendChild(img);
                return item;
            }
    
            async loadImages() {
                if (this.isLoading || !this.hasMoreImages) return;
                
                this.isLoading = true;
                this.loadingElement.style.display = 'block';
                this.loadingElement.textContent = '載入中...';
    
                const newImages = this.getRandomImages(this.batchSize);
                if (newImages.length === 0) {
                    this.loadingElement.textContent = '已顯示所有圖片';
                    this.isLoading = false;
                    return;
                }
    
                newImages.forEach(url => {
                    this.displayedImages.add(url);
                    const imageElement = this.createImageElement(url);
                    this.imageGrid.appendChild(imageElement);
                    this.items.push(imageElement);
                });
    
                this.updateCount();
                this.loadingElement.style.display = this.hasMoreImages ? 'block' : 'none';
                this.isLoading = false;
            }
    
            setupInfiniteScroll() {
                const observer = new IntersectionObserver((entries) => {
                    if (entries[0].isIntersecting && !this.isLoading && this.hasMoreImages) {
                        this.loadImages();
                    }
                });
    
                observer.observe(this.loadingElement);
            }
    
            setupRefreshButton() {
                this.refreshButton.addEventListener('click', () => {
                    this.displayedImages.clear();
                    this.imageGrid.innerHTML = '';
                    this.items = [];
                    this.hasMoreImages = true;
                    this.loadImages();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
        }
    
        new ImageGallery();
        </script>
</body>
</html>